{% extends "base.html" %}

{% block title %}Article Analyzer - Analyze Claims{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h2 class="card-title mb-0">üìä Analyze Article Claims</h2>
            </div>
            <div class="card-body">
                <p class="lead">Enter an article URL to analyze its claims and detect potential misinformation through "microlies" analysis.</p>
                
                <form method="POST" action="{{ url_for('analyze_article') }}">
                    <!-- Input Method Selection -->
                    <div class="mb-3">
                        <label class="form-label">Input Method</label>
                        <div class="btn-group w-100" role="group" aria-label="Input method">
                            <input type="radio" class="btn-check" name="input_method" id="url_method" value="url" checked>
                            <label class="btn btn-outline-primary" for="url_method">üîó URL</label>
                            
                            <input type="radio" class="btn-check" name="input_method" id="text_method" value="text">
                            <label class="btn btn-outline-primary" for="text_method">üìù Direct Text</label>
                        </div>
                    </div>

                    <!-- URL Input -->
                    <div class="mb-3" id="url_input">
                        <label for="url" class="form-label">Article URL</label>
                        <input type="url" class="form-control" id="url" name="url"
                               value="{{ url or 'https://en.wikipedia.org/wiki/Health_Information_Technology_for_Economic_and_Clinical_Health_Act' }}"
                               placeholder="https://en.wikipedia.org/wiki/Health_Information_Technology_for_Economic_and_Clinical_Health_Act"
                               pattern="https?://.*">
                        <div class="form-text">Enter the full URL of the article you want to analyze</div>
                    </div>

                    <!-- Text Input -->
                    <div class="mb-3 d-none" id="text_input">
                        <label for="article_text" class="form-label">Article Text</label>
                        <textarea class="form-control" id="article_text" name="article_text" rows="8"
                                  placeholder="Paste your article text here..."></textarea>
                        <div class="form-text">Paste the article text directly into this field</div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="llm_model" class="form-label">Language Model</label>
                                <select class="form-select" id="llm_model" name="llm_model">
                                    <option value="o3" {% if llm_model == 'o3' %}selected{% endif %}>o3 (Best Reasoning)</option>
                                    <option value="o3-mini" {% if llm_model == 'o3-mini' %}selected{% endif %}>o3-mini (Fast Reasoning)</option>
                                    <option value="gpt-4o-mini" {% if llm_model == 'gpt-4o-mini' or not llm_model %}selected{% endif %}>GPT-4o Mini (Fast, Cheap)</option>
                                    <option value="gpt-4o" {% if llm_model == 'gpt-4o' %}selected{% endif %}>GPT-4o (Better Quality)</option>
                                    <option value="gpt-4.1" {% if llm_model == 'gpt-4.1' %}selected{% endif %}>GPT-4.1 (Latest)</option>
                                    <option value="gpt-4.1-mini" {% if llm_model == 'gpt-4.1-mini' %}selected{% endif %}>GPT-4.1 Mini (Fast, Latest)</option>
                                    <option value="gpt-4-turbo" {% if llm_model == 'gpt-4-turbo' %}selected{% endif %}>GPT-4 Turbo</option>
                                    <option value="gpt-3.5-turbo" {% if llm_model == 'gpt-3.5-turbo' %}selected{% endif %}>GPT-3.5 Turbo (Fastest)</option>
                                </select>
                                <div class="form-text">Choose AI model for analysis</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="skip_sentences" class="form-label">Skip Sentences</label>
                                <input type="number" class="form-control" id="skip_sentences" name="skip_sentences" 
                                       min="0" value="{{ skip_sentences or '3' }}" placeholder="3">
                                <div class="form-text">Skip first N sentences</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="max_sentences" class="form-label">Max Sentences</label>
                                <input type="number" class="form-control" id="max_sentences" name="max_sentences" 
                                       min="1" max="5" value="{{ max_sentences or '5' }}" placeholder="5">
                                <div class="form-text">Limit analysis to N sentences (max: 5)</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="max_claims" class="form-label">Max Claims/Sentence</label>
                                <input type="number" class="form-control" id="max_claims" name="max_claims" 
                                       min="1" max="10" value="{{ max_claims or '10' }}" placeholder="10">
                                <div class="form-text">Limit claims per sentence (max: 10)</div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="analyzeBtn">
                            <span class="spinner-border spinner-border-sm me-2 d-none" id="spinner"></span>
                            üîç Analyze Article
                        </button>
                    </div>
                </form>

                <div class="mt-4">
                    <h5>How it works:</h5>
                    <ol class="small text-muted">
                        <li><strong>Extract Claims:</strong> AI identifies potential claims in each sentence</li>
                        <li><strong>Assess Interpretation:</strong> Calculate probability readers would interpret the author as making each claim</li>
                        <li><strong>Evaluate Truth:</strong> Estimate probability each claim is actually true</li>
                        <li><strong>Calculate Microlies:</strong> Combine probabilities using formula (P(claim made) √ó P(claim false))¬≥</li>
                        <li><strong>Aggregate Results:</strong> Sum microlies for sentences and entire article</li>
                    </ol>
                </div>

                <div class="alert alert-info mt-3">
                    <strong>Performance Limits:</strong> 
                    <ul class="mb-0 mt-2">
                        <li>Maximum 50 sentences per analysis</li>
                        <li>Maximum 10 claims per sentence</li>
                        <li>Processing takes 1-3 minutes depending on article length</li>
                        <li>Analysis will timeout after 4 minutes to prevent server overload</li>
                        <li>If timeout occurs, try reducing the number of sentences</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <h4>Sample Articles to Try:</h4>
            <div class="list-group">
                <button class="list-group-item list-group-item-action" onclick="fillUrl('https://en.wikipedia.org/wiki/Health_Information_Technology_for_Economic_and_Clinical_Health_Act')">
                    üìä Wikipedia: HITECH Act (Health Information Technology)
                </button>
                <button class="list-group-item list-group-item-action" onclick="fillUrl('https://forum.effectivealtruism.org/posts/YJ7Pk2bwTd3ieimG8/metr-measuring-ai-ability-to-complete-long-tasks')">
                    üìà METR: Measuring AI ability to complete long tasks
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function fillUrl(url) {
    document.getElementById('url').value = url;
    // Switch to URL method if needed
    document.getElementById('url_method').checked = true;
    toggleInputMethod();
}

function toggleInputMethod() {
    const urlMethod = document.getElementById('url_method').checked;
    const urlInput = document.getElementById('url_input');
    const textInput = document.getElementById('text_input');
    const urlField = document.getElementById('url');
    const textField = document.getElementById('article_text');
    
    if (urlMethod) {
        urlInput.classList.remove('d-none');
        textInput.classList.add('d-none');
        urlField.required = true;
        textField.required = false;
    } else {
        urlInput.classList.add('d-none');
        textInput.classList.remove('d-none');
        urlField.required = false;
        textField.required = true;
    }
}

// Add event listeners
document.getElementById('url_method').addEventListener('change', toggleInputMethod);
document.getElementById('text_method').addEventListener('change', toggleInputMethod);

document.querySelector('form').addEventListener('submit', function() {
    const btn = document.getElementById('analyzeBtn');
    const spinner = document.getElementById('spinner');
    
    btn.disabled = true;
    spinner.classList.remove('d-none');
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analyzing...';
});

// Initialize on page load
toggleInputMethod();
</script>
{% endblock %}